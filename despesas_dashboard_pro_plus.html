
<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <title>Despesas Dashboard PRO+</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Garante que qualquer sessão anterior é anulada antes de renderizar o HTML
      try { localStorage.setItem("sessionPRO_v1", ""); } catch {}
    </script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      background: radial-gradient(circle at top left,#22c55e,#0f172a 55%);
      padding: 1.2rem 1.5rem 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.35rem;
    }
    header p {
      margin: 0.25rem 0 0 0;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 1rem 1.1rem;
      margin-bottom: 1rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.40);
      border: 1px solid rgba(148,163,184,0.35);
    }
    h2 {
      margin-top: 0;
      font-size: 1.05rem;
    }
    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.15rem;
    }
    input, select, textarea, button {
      font-family: inherit;
      font-size: 0.9rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    select,
    textarea {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 1.1rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: none;
    }
    .btn-primary {
      background: #22c55e;
      color: #052e16;
      box-shadow: 0 12px 30px rgba(34,197,94,0.40);
    }
    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn-danger {
      background: #ef4444;
      color: #fef2f2;
      font-size: 0.78rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .btn-small {
      font-size: 0.78rem;
      padding: 0.3rem 0.65rem;
    }
    .flex {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 160px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .stat {
      padding: 0.7rem 0.8rem;
      border-radius: 12px;
      background: radial-gradient(circle at top left,#0b1120,#020617);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .stat-title {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.15rem;
    }
    .stat-value {
      font-size: 1.05rem;
      font-weight: 700;
    }
    .stat-neg { color: #f97373; }
    .stat-pos { color: #4ade80; }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      gap: 0.25rem;
    }
    .badge-despesa {
      background: rgba(248,113,113,0.15);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.6);
    }
    .badge-receita {
      background: rgba(52,211,153,0.12);
      color: #bbf7d0;
      border: 1px solid rgba(52,211,153,0.6);
    }
    .badge-pessoa {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
      border: 1px solid rgba(59,130,246,0.6);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.83rem;
    }

      th, td {
        padding: 0.45rem 0.4rem;
        border-bottom: 1px solid #1f2933;
        text-align: left;
        white-space: nowrap;
      }
      .table-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
      }
      .dashboard-table {
        border: 1px solid rgba(148,163,184,0.3);
        border-radius: 10px;
        overflow: hidden;
      }
      .dashboard-table caption {
        text-align: left;
        font-weight: 700;
        font-size: 0.9rem;
        padding: 0.6rem 0.75rem 0.1rem 0.75rem;
        color: #e5e7eb;
      }
      .dashboard-table tbody tr:hover {
        background: rgba(52,211,153,0.08);
      }
    th {
      background: rgba(15,23,42,0.9);
      font-weight: 600;
      font-size: 0.78rem;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.75);
    }
    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.4);
    }
    .amount-despesa {
      color: #fecaca;
      font-weight: 600;
    }
    .amount-receita {
      color: #bbf7d0;
      font-weight: 600;
    }
    .pill-progress {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 0.2rem;
    }
    .pill-progress-inner {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg,#22c55e,#a3e635);
      width: 0%;
      transition: width 0.25s ease;
    }
    .notif-bar {
      margin: 0.5rem auto;
      max-width: 1100px;
      padding: 0.55rem 0.75rem;
      border-radius: 999px;
      background: rgba(250,204,21,0.15);
      border: 1px solid rgba(250,204,21,0.7);
      color: #facc15;
      font-size: 0.78rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .notif-bar strong { font-weight: 700; }
    .notif-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.78rem;
    }
    .notif-pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(250,204,21,0.12);
      border: 1px dashed rgba(250,204,21,0.5);
    }
    @media (max-width: 720px) {
      th:nth-child(2),
      td:nth-child(2) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Despesas Dashboard PRO+</h1>
    <p>Despesas Helder • Goreti • Conjunto · Débitos diretos · Metas · Planeamento · Backup</p>
  </header>

  <div id="notifArea" class="notif-bar">
    <div class="notif-list" id="notifList"></div>
    <button id="notifClose" class="btn-secondary btn-small" style="border-radius:999px;">Fechar</button>
  </div>

  <main>

    <!-- AUTENTICAÇÃO & SESSÃO -->
    <section class="card">
      <div class="flex-between">
        <h2>Login, passwords e segurança</h2>
        <small style="color:#9ca3af;">Admin pode mudar passwords, remover ou criar utilizadores</small>
      </div>
      <div class="flex" style="align-items:flex-end;">
        <div class="col">
          <label for="loginUsername">Utilizador</label>
          <input id="loginUsername" placeholder="Ex: admin, Helder, Goreti">
        </div>
        <div class="col">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="••••••">
        </div>
        <div class="col" style="flex:0 0 140px;">
          <button class="btn-primary btn-small" id="loginBtn">Entrar</button>
          <button class="btn-secondary btn-small" id="logoutBtn" style="margin-left:0.4rem;">Sair</button>
        </div>
      </div>
      <div style="margin-top:0.4rem; font-size:0.86rem;">
        <div id="sessionStatus" style="margin-bottom:0.25rem;"></div>
        <div style="color:#9ca3af;">Predefinição: admin / admin. Muda já a password!</div>
      </div>
    </section>

    <div id="appContent" style="display:none;">

    <!-- GESTÃO DE UTILIZADORES (APENAS ADMIN) -->
    <section class="card" data-admin-only="true">
      <div class="flex-between">
        <h2>Gestão de utilizadores</h2>
        <small style="color:#9ca3af;">Admin consegue repor passes, adicionar/remover utilizadores</small>
      </div>
      <div class="flex" style="align-items:flex-end;">
        <div class="col">
          <label for="newUserName">Novo utilizador</label>
          <input id="newUserName" placeholder="Ex: Helder2">
        </div>
        <div class="col">
          <label for="newUserPass">Password inicial</label>
          <input type="password" id="newUserPass" placeholder="Define aqui">
        </div>
        <div class="col">
          <label for="newUserRole">Perfil</label>
          <select id="newUserRole">
            <option value="admin">Admin</option>
            <option value="Helder">Helder</option>
            <option value="Goreti">Goreti</option>
            <option value="Conjunto">Conjunto</option>
          </select>
        </div>
        <div class="col" style="flex:0 0 140px;">
          <button class="btn-primary btn-small" id="addUserBtn">Criar utilizador</button>
        </div>
      </div>
      <div style="margin-top:0.6rem; font-size:0.86rem;">
        <strong>Utilizadores ativos:</strong>
        <div id="userList" style="margin-top:0.35rem; display:flex; flex-wrap:wrap; gap:0.35rem;"></div>
      </div>
    </section>

    <!-- PERMISSÕES DE ACESSO AO "CONJUNTO" -->
    <section class="card" data-admin-only="true">
      <div class="flex-between">
        <h2>Regras de quem vê o Conjunto</h2>
        <small style="color:#9ca3af;">Helder nunca vê Goreti e vice-versa. Aqui decides quem pode ver o Conjunto.</small>
      </div>
      <div class="flex" style="align-items:center;">
        <button class="btn-secondary btn-small" id="adminOnlyConjunto">Conjunto só para Admin</button>
        <button class="btn-primary btn-small" id="toggleHelderConjunto">Helder pode ver Conjunto</button>
        <button class="btn-primary btn-small" id="toggleGoretiConjunto">Goreti pode ver Conjunto</button>
      </div>
      <div id="permissionsStatus" style="margin-top:0.6rem; font-size:0.86rem; color:#9ca3af;"></div>
    </section>

    <!-- DASHBOARD -->
    <section class="card">
      <div class="flex-between">
        <h2>Dashboard mensal</h2>
        <div class="flex" style="align-items:flex-end;">
          <div class="col" style="flex:0 0 140px;">
            <label for="monthFilter">Mês</label>
            <input type="month" id="monthFilter">
          </div>
          <div class="col" style="flex:0 0 140px;">
            <label for="saldoInicial">Saldo inicial (€)</label>
            <input type="number" id="saldoInicial" step="0.01" value="0">
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-title">Saldo do mês</div>
          <div class="stat-value" id="saldoMes">0,00 €</div>
        </div>
        <div class="stat">
          <div class="stat-title">Total despesas</div>
          <div class="stat-value stat-neg" id="totalDespesas">0,00 €</div>
        </div>
        <div class="stat">
          <div class="stat-title">Total receitas</div>
          <div class="stat-value stat-pos" id="totalReceitas">0,00 €</div>
        </div>
        <div class="stat">
          <div class="stat-title">Poupança (receitas - despesas)</div>
          <div class="stat-value" id="poupancaMes">0,00 €</div>
        </div>
      </div>

      <div class="stats" style="margin-top:1rem;">
        <div class="stat">
          <div class="stat-title">Helder · meta vs real</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaHelderLabel">Meta: - €</span>
            <span id="realHelderLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaHelderBar" class="pill-progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="stat-title">Goreti · meta vs real</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaNamoradaLabel">Meta: - €</span>
            <span id="realNamoradaLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaNamoradaBar" class="pill-progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="stat-title">Conjunto · meta vs real</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaConjuntoLabel">Meta: - €</span>
            <span id="realConjuntoLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaConjuntoBar" class="pill-progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="stat-title">Meta de poupança · progresso</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaPoupancaLabel">Meta: - €</span>
            <span id="realPoupancaLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaPoupancaBar" class="pill-progress-inner"></div></div>
        </div>
      </div>

        <div class="table-grid">
          <table class="dashboard-table">
            <caption>Resumo do mês</caption>
            <thead>
              <tr><th>Indicador</th><th>Valor</th></tr>
            </thead>
            <tbody id="resumoMensalBody">
              <tr><td>Despesas</td><td>—</td></tr>
              <tr><td>Receitas</td><td>—</td></tr>
              <tr><td>Poupança</td><td>—</td></tr>
              <tr><td>Saldo (com saldo inicial)</td><td>—</td></tr>
            </tbody>
          </table>

          <table class="dashboard-table">
            <caption>Despesas por categoria</caption>
            <thead>
              <tr><th>Categoria</th><th>Total</th></tr>
            </thead>
            <tbody id="tabelaCategoriasBody">
              <tr><td colspan="2">Sem dados</td></tr>
            </tbody>
          </table>

          <table class="dashboard-table">
            <caption>Despesas por pessoa</caption>
            <thead>
              <tr><th>Pessoa</th><th>Total</th></tr>
            </thead>
            <tbody id="tabelaPessoasBody">
              <tr><td colspan="2">Sem dados</td></tr>
            </tbody>
          </table>
        </div>
      </section>

    <!-- NOVO MOVIMENTO -->
    <section class="card">
      <div class="flex-between">
        <h2>Novo movimento (despesa / receita)</h2>
        <small style="color:#9ca3af;">Guardado automaticamente neste dispositivo (localStorage)</small>
      </div>
      <div class="flex">
        <div class="col">
          <label for="data">Data</label>
          <input type="date" id="data">
        </div>
        <div class="col" style="flex:2 1 220px;">
          <label for="descricao">Descrição</label>
          <input type="text" id="descricao" placeholder="Ex: renda, luz, salário...">
        </div>
        <div class="col">
          <label for="valor">Valor (€)</label>
          <input type="number" id="valor" step="0.01">
        </div>
      </div>
      <div class="flex" style="margin-top:0.65rem;">
        <div class="col">
          <label for="tipo">Tipo</label>
          <select id="tipo">
            <option value="despesa">Despesa</option>
            <option value="receita">Receita</option>
          </select>
        </div>
        <div class="col">
          <label for="pessoa">Pessoa</label>
          <select id="pessoa">
            <option value="Helder">Helder</option>
            <option value="Goreti">Goreti</option>
            <option value="Conjunto">Conjunto</option>
          </select>
        </div>
        <div class="col">
          <label for="categoria">Categoria</label>
          <select id="categoria"></select>
        </div>
      </div>
      <div style="margin-top:0.8rem; text-align:right;">
        <button class="btn-primary" id="addBtn">Adicionar</button>
      </div>
    </section>

    <!-- DÉBITOS DIRETOS -->
    <section class="card">
      <div class="flex-between">
        <h2>Débitos diretos (mensais)</h2>
        <small style="color:#9ca3af;">Recebes aviso visual e (se possível) notificação no dia do débito</small>
      </div>
      <div class="flex">
        <div class="col">
          <label for="ddDescricao">Descrição</label>
          <input type="text" id="ddDescricao" placeholder="Ex: Renda, Netflix, Seguro...">
        </div>
        <div class="col">
          <label for="ddValor">Valor (€)</label>
          <input type="number" id="ddValor" step="0.01">
        </div>
        <div class="col">
          <label for="ddDia">Dia do mês</label>
          <input type="number" id="ddDia" min="1" max="31" placeholder="Ex: 5">
        </div>
        <div class="col">
          <label for="ddPessoa">Pessoa</label>
          <select id="ddPessoa">
            <option value="Helder">Helder</option>
            <option value="Goreti">Goreti</option>
            <option value="Conjunto">Conjunto</option>
          </select>
        </div>
      </div>
      <div style="margin-top:0.7rem; text-align:right;">
        <button class="btn-primary btn-small" id="addDebitoBtn">Adicionar débito direto</button>
      </div>
      <div style="margin-top:0.8rem; max-height:190px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Dia</th>
              <th>Descrição</th>
              <th>Pessoa</th>
              <th>Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tabelaDebitos"></tbody>
        </table>
      </div>
    </section>

    <!-- METAS & PLANEAMENTO -->
    <section class="card">
      <h2>Metas & planeamento</h2>
      <div class="flex">
        <div class="col">
          <label for="metaHelder">Meta despesas Helder / mês (€)</label>
          <input type="number" id="metaHelder" step="0.01" placeholder="Ex: 600">
        </div>
        <div class="col">
          <label for="metaNamorada">Meta despesas Goreti / mês (€)</label>
          <input type="number" id="metaNamorada" step="0.01" placeholder="Ex: 400">
        </div>
        <div class="col">
          <label for="metaConjunto">Meta despesas Conjunto / mês (€)</label>
          <input type="number" id="metaConjunto" step="0.01" placeholder="Ex: 500">
        </div>
        <div class="col">
          <label for="metaPoupanca">Meta poupança / mês (€)</label>
          <input type="number" id="metaPoupanca" step="0.01" placeholder="Ex: 300">
        </div>
      </div>
      <div style="margin-top:0.8rem;">
        <label for="planeamentoNotas">Planeamento / notas para este ano</label>
        <textarea id="planeamentoNotas" placeholder="Ex: pagar dívida X até março, guardar para férias em agosto, etc."></textarea>
      </div>
      <div style="margin-top:0.7rem; text-align:right;">
        <button class="btn-primary btn-small" id="saveMetasBtn">Guardar metas & planeamento</button>
      </div>
    </section>

    <!-- CATEGORIAS PERSONALIZADAS -->
    <section class="card">
      <div class="flex-between">
        <h2>Categorias personalizadas</h2>
        <small style="color:#9ca3af;">Adiciona as tuas próprias categorias de despesa/receita</small>
      </div>
      <div class="flex" style="align-items:flex-end;">
        <div class="col" style="flex:2 1 220px;">
          <label for="novaCategoria">Nova categoria</label>
          <input id="novaCategoria" placeholder="Ex: Gatos, Gaming, Subscripções...">
        </div>
        <div class="col" style="flex:0 0 120px;">
          <button class="btn-primary btn-small" id="addCategoria">Adicionar</button>
        </div>
      </div>
      <div style="margin-top:0.7rem; font-size:0.82rem;">
        <strong>Categorias ativas:</strong>
        <div id="listaCategorias" style="margin-top:0.4rem; display:flex; flex-wrap:wrap; gap:0.35rem;"></div>
      </div>
    </section>

    <!-- BACKUP -->
    <section class="card">
      <div class="flex-between">
        <h2>Backup & recuperação</h2>
        <small style="color:#9ca3af;">Exporta tudo para um ficheiro .json e guarda no Google Drive / e-mail</small>
      </div>
      <div class="flex" style="align-items:center; margin-top:0.6rem;">
        <div class="col" style="flex:0 0 180px;">
          <button class="btn-secondary btn-small" id="exportBackupBtn">Exportar backup (.json)</button>
        </div>
        <div class="col" style="flex:0 0 220px;">
          <label for="backupFile">Importar backup (.json)</label>
          <input type="file" id="backupFile" accept="application/json">
        </div>
        <div class="col" style="font-size:0.78rem; color:#9ca3af;">
          Dica: guarda o backup automaticamente no Google Drive (sincronizado) para não perderes nada.
        </div>
      </div>
    </section>

    <!-- EXPORTAÇÃO PARA EXCEL/CSV & GOOGLE SHEETS -->
    <section class="card">
      <div class="flex-between">
        <h2>Exportação rápida</h2>
        <small style="color:#9ca3af;">Excel/CSV e atalho para colar diretamente no Google Sheets</small>
      </div>
      <div class="flex" style="align-items:center; margin-top:0.6rem;">
        <div class="col" style="flex:0 0 180px;">
          <button class="btn-primary btn-small" id="exportCsvBtn">Exportar Excel/CSV</button>
        </div>
        <div class="col" style="flex:0 0 220px;">
          <button class="btn-secondary btn-small" id="copySheetsBtn">Copiar para Google Sheets</button>
        </div>
        <div class="col" style="font-size:0.78rem; color:#9ca3af;">
          Abre o Google Sheets e cola (Ctrl+V) para teres os dados atualizados ou usa o CSV no Excel.
        </div>
      </div>
    </section>

    <!-- DICAS PARA TELEMÓVEL -->
    <section class="card">
      <div class="flex-between">
        <h2>Usar no telemóvel (iPhone/Android)</h2>
        <small style="color:#9ca3af;">Funciona offline porque fica guardado no próprio dispositivo</small>
      </div>
      <ul style="margin:0; padding-left:1.1rem; color:#9ca3af; font-size:0.9rem; line-height:1.45;">
        <li><strong>iPhone:</strong> guarda este ficheiro no iCloud Drive/Arquivos, abre no Safari e toca em <em>Partilhar</em> → <em>Adicionar ao ecrã principal</em>. Passa a ter um ícone que abre a app em ecrã inteiro.</li>
        <li><strong>Android:</strong> abre o ficheiro no Chrome, usa os três pontos → <em>Adicionar à tela inicial</em>.</li>
        <li>Os dados ficam em <code>localStorage</code> de cada telemóvel. Para dois telemóveis iguais, partilha o backup .json pelo Google Drive/iCloud, importa no segundo e volta a exportar sempre que houver alterações.</li>
      </ul>
    </section>

    <!-- SINCRONIZAÇÃO / USO EM MAIS DISPOSITIVOS -->
    <section class="card">
      <div class="flex-between">
        <h2>Sincronização em simultâneo</h2>
        <small style="color:#9ca3af;">Atualiza em tempo real entre separadores/PCs com o mesmo ficheiro aberto</small>
      </div>
      <p style="margin:0; color:#9ca3af; font-size:0.86rem;">Em telemóveis distintos usa o backup (.json) para alinhar dados: exporta num e importa noutro. O botão abaixo força a sincronização instantânea apenas entre janelas que estejam a correr o mesmo ficheiro.</p>
      <div style="margin-top:0.6rem;" class="flex">
        <button class="btn-primary btn-small" id="forceSyncBtn">Forçar sincronização agora</button>
        <div id="syncStatus" style="font-size:0.86rem; color:#9ca3af;"></div>
      </div>
    </section>

    <!-- BACKEND DEDICADO (OPCIONAL) -->
    <section class="card">
      <div class="flex-between">
        <h2>Backend dedicado gratuito (Supabase)</h2>
        <small style="color:#9ca3af;">Sincronização automática entre telemóveis/PCs</small>
      </div>
      <p style="margin:0; color:#9ca3af; font-size:0.9rem; line-height:1.45;">
        Preenche os dados do teu projeto Supabase (plano Free) para ativares sync automático. O login interno continua obrigatório; este passo só serve para alinhar o snapshot entre dispositivos.
      </p>
      <div class="flex" style="margin-top:0.6rem; gap:0.6rem;">
        <div class="col">
          <label for="supabaseUrl">Project URL</label>
          <input id="supabaseUrl" placeholder="https://xxxx.supabase.co" autocomplete="off">
        </div>
        <div class="col">
          <label for="supabaseAnon">Anon key</label>
          <input id="supabaseAnon" placeholder="chave pública anon" autocomplete="off">
        </div>
        <div class="col">
          <label for="supabaseEmail">Email (Supabase Auth)</label>
          <input id="supabaseEmail" type="email" placeholder="email do utilizador" autocomplete="off">
        </div>
        <div class="col">
          <label for="supabasePassword">Password (Supabase Auth)</label>
          <input id="supabasePassword" type="password" placeholder="password" autocomplete="off">
        </div>
      </div>
      <div class="flex" style="align-items:center; margin-top:0.5rem; gap:0.75rem;">
        <label style="display:flex; align-items:center; gap:0.35rem; font-size:0.85rem; color:#e5e7eb;">
          <input type="checkbox" id="supabaseEnable"> Ativar sync automático (pull no login, push ao gravar)
        </label>
        <button class="btn-primary btn-small" id="saveSupabaseCfg">Guardar configuração</button>
        <button class="btn-secondary btn-small" id="pullSupabase">Pull agora</button>
        <button class="btn-secondary btn-small" id="pushSupabase">Push agora</button>
        <button class="btn-danger" id="logoutSupabase">Sair do Supabase</button>
      </div>
      <div id="supabaseStatus" style="margin-top:0.45rem; font-size:0.86rem; color:#9ca3af;"></div>
    </section>

    <!-- LISTA DE MOVIMENTOS -->
    <section class="card">
      <div class="flex-between">
        <h2>Movimentos do mês</h2>
        <small style="color:#9ca3af;">A lista respeita o mês escolhido no dashboard</small>
      </div>
      <div style="max-height:260px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Pessoa</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tabelaBody"></tbody>
        </table>
      </div>
    </section>

    </div> <!-- /appContent -->

  </main>

  <script>
    const STORAGE_MAIN   = "despesasPRO_v2";
    const STORAGE_CATS   = "categoriasPRO_v2";
    const STORAGE_DEBITS = "debitosPRO_v2";
    const STORAGE_GOALS  = "metasPRO_v2";
    const STORAGE_NOTIF  = "notifPRO_v2";
    const STORAGE_SALDO  = "saldoInicialPRO_v2";
    const STORAGE_USERS  = "usersPRO_v1";
    const STORAGE_SETTINGS = "settingsPRO_v1";
    const STORAGE_SESSION = "sessionPRO_v1";
    const SYNC_CHANNEL_NAME = "despesasPRO_sync";
    const STORAGE_SUPABASE = "supabaseCfg_v1";

    // Utils
    function formatCurrency(value) {
      const n = Number(value) || 0;
      return n.toLocaleString("pt-PT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    }
    function getCurrentMonth() {
      const input = document.getElementById("monthFilter");
      if (input && input.value) return input.value;
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const year = today.getFullYear();
      return year + "-" + month;
    }
    function filterByMonth(arr, monthStr) {
      return arr.filter(item => item.data && item.data.startsWith(monthStr));
    }

    const encoder = new TextEncoder();
    function simpleHash(str) {
      // Base64 da string para não ficar password em claro.
      return btoa(String.fromCharCode(...encoder.encode(str)));
    }

    // Users & permissões
    function loadUsers() {
      try { return JSON.parse(localStorage.getItem(STORAGE_USERS) || "[]"); }
      catch { return []; }
    }
    function saveUsers(arr) {
      localStorage.setItem(STORAGE_USERS, JSON.stringify(arr));
      broadcastSync();
      queueSupabasePush();
    }
    function ensureDefaultUsers() {
      let users = loadUsers();
      if (!users.length) {
        users = [
          { username:"admin", role:"admin", pass: simpleHash("admin") },
          { username:"Helder", role:"Helder", pass: simpleHash("1234") },
          { username:"Goreti", role:"Goreti", pass: simpleHash("1234") },
          { username:"Conjunto", role:"Conjunto", pass: simpleHash("1234") }
        ];
      }
      // garante que o admin existe sempre
      if (!users.some(u => u.username === "admin")) {
        users.push({ username:"admin", role:"admin", pass: simpleHash("admin") });
      }
      saveUsers(users);
    }

    function loadSettings() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_SETTINGS) || "{}");
      } catch {
        return {};
      }
    }
    function saveSettings(obj) {
      localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(obj));
      broadcastSync();
      queueSupabasePush();
    }

    function getSessionUser() {
      const sessionName = localStorage.getItem(STORAGE_SESSION);
      const users = loadUsers();
      return users.find(u => u.username === sessionName) || null;
    }
    function setSessionUser(username) {
      localStorage.setItem(STORAGE_SESSION, username || "");
      broadcastSync();
    }
    function logoutUser() {
      setSessionUser("");
    }

    function allowedPessoas(user) {
      const settings = loadSettings();
      if (user && user.role === "admin") return ["Helder","Goreti","Conjunto"];
      if (!user) return [];
      if (user.role === "Helder") {
        return settings.allowHelderConjunto ? ["Helder","Conjunto"] : ["Helder"];
      }
      if (user.role === "Goreti") {
        return settings.allowGoretiConjunto ? ["Goreti","Conjunto"] : ["Goreti"];
      }
      if (user.role === "Conjunto") return ["Conjunto"];
      return [];
    }
    function filterDataForUser(data) {
      const user = getSessionUser();
      const allowed = allowedPessoas(user);
      return data.filter(item => allowed.includes(item.pessoa));
    }

    let syncChannel = null;
    let lastSyncTs = 0;
    let supabaseClient = null;
    let supabaseClientUrl = "";
    let supabaseSession = null;
    let supabasePushTimer = null;
    function getFullSnapshot() {
      return {
        movimentos: loadMovimentos(),
        categorias: loadCategorias(),
        debitos: loadDebitos(),
        metas: loadMetas(),
        saldoInicial: loadSaldoInicial(),
        users: loadUsers(),
        settings: loadSettings(),
        session: localStorage.getItem(STORAGE_SESSION) || ""
      };
    }
    function applySnapshot(data) {
      if (!data) return;
      if (data.movimentos) localStorage.setItem(STORAGE_MAIN, JSON.stringify(data.movimentos));
      if (data.categorias) localStorage.setItem(STORAGE_CATS, JSON.stringify(data.categorias));
      if (data.debitos) localStorage.setItem(STORAGE_DEBITS, JSON.stringify(data.debitos));
      if (data.metas) localStorage.setItem(STORAGE_GOALS, JSON.stringify(data.metas));
      if (typeof data.saldoInicial !== "undefined") localStorage.setItem(STORAGE_SALDO, String(data.saldoInicial));
      if (data.users) localStorage.setItem(STORAGE_USERS, JSON.stringify(data.users));
      if (data.settings) localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(data.settings));
      if (typeof data.session !== "undefined") localStorage.setItem(STORAGE_SESSION, data.session);
    }

    // Supabase helpers
    function loadSupabaseConfig() {
      try { return JSON.parse(localStorage.getItem(STORAGE_SUPABASE) || "{}"); }
      catch { return {}; }
    }
    function saveSupabaseConfig(cfg) {
      localStorage.setItem(STORAGE_SUPABASE, JSON.stringify(cfg || {}));
    }
    function supabaseConfigEnabled(cfg) {
      return !!(cfg && cfg.enabled && cfg.url && cfg.anon && cfg.email && cfg.password);
    }
    function setSupabaseStatus(msg, isError=false) {
      const el = document.getElementById("supabaseStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.style.color = isError ? "#fca5a5" : "#9ca3af";
    }
    function ensureSupabaseClient(cfg) {
      if (!window.supabase || !window.supabase.createClient) {
        setSupabaseStatus("Biblioteca Supabase não carregada.", true);
        return null;
      }
      if (!supabaseClient || supabaseClientUrl !== cfg.url) {
        supabaseClient = window.supabase.createClient(cfg.url, cfg.anon);
        supabaseClientUrl = cfg.url;
      }
      return supabaseClient;
    }
    async function supabaseLogin() {
      const cfg = loadSupabaseConfig();
      if (!supabaseConfigEnabled(cfg)) return null;
      const client = ensureSupabaseClient(cfg);
      if (!client) return null;
      if (supabaseSession && supabaseSession.user) return supabaseSession.user;
      setSupabaseStatus("A iniciar sessão no Supabase...");
      const { data, error } = await client.auth.signInWithPassword({ email: cfg.email, password: cfg.password });
      if (error) {
        setSupabaseStatus("Falha no login Supabase: " + error.message, true);
        return null;
      }
      supabaseSession = data.session;
      setSupabaseStatus("Autenticado no Supabase.");
      return data.session?.user || null;
    }
    async function supabasePullLatest(showEmptyMsg=true) {
      const user = await supabaseLogin();
      if (!user) return;
      setSupabaseStatus("A obter dados do Supabase...");
      const { data, error } = await supabaseClient
        .from('despesas_sync')
        .select('payload, updated_at')
        .eq('user_id', user.id)
        .maybeSingle();
      if (error) {
        setSupabaseStatus("Erro a ler do Supabase: " + error.message, true);
        return;
      }
      if (data && data.payload) {
        const currentSessionName = localStorage.getItem(STORAGE_SESSION);
        applySnapshot(data.payload);
        if (currentSessionName) localStorage.setItem(STORAGE_SESSION, currentSessionName);
        renderTudo();
        const stamp = data.updated_at ? data.updated_at.replace('T',' ').slice(0,19) : new Date().toLocaleString();
        setSupabaseStatus("Dados importados do Supabase em " + stamp + ".");
      } else if (showEmptyMsg) {
        setSupabaseStatus("Ainda não há snapshot remoto. Faz um push para criar.");
      }
    }
    async function supabasePushLatest() {
      const user = await supabaseLogin();
      if (!user) return;
      setSupabaseStatus("A gravar snapshot no Supabase...");
      const payload = getFullSnapshot();
      const { error } = await supabaseClient
        .from('despesas_sync')
        .upsert({ user_id: user.id, payload, updated_at: new Date().toISOString() }, { onConflict: 'user_id' });
      if (error) {
        setSupabaseStatus("Erro ao gravar no Supabase: " + error.message, true);
        return;
      }
      setSupabaseStatus("Snapshot enviado para o Supabase.");
    }
    function queueSupabasePush() {
      const cfg = loadSupabaseConfig();
      if (!supabaseConfigEnabled(cfg)) return;
      clearTimeout(supabasePushTimer);
      supabasePushTimer = setTimeout(() => {
        supabasePushLatest().catch(err => setSupabaseStatus("Erro de sync: " + (err?.message || err), true));
      }, 400);
    }
    async function supabaseLogout() {
      if (supabaseClient) await supabaseClient.auth.signOut();
      supabaseSession = null;
      setSupabaseStatus("Sessão Supabase terminada.");
    }
    async function supabaseAutoPullAfterLogin() {
      const cfg = loadSupabaseConfig();
      if (!supabaseConfigEnabled(cfg)) return;
      await supabasePullLatest(false);
    }
    function updateSyncStatus(msg) {
      const el = document.getElementById("syncStatus");
      if (el) el.textContent = msg || "";
    }
    function broadcastSync() {
      if (!syncChannel) return;
      const payload = { ts: Date.now(), snapshot: getFullSnapshot() };
      syncChannel.postMessage(payload);
      updateSyncStatus("Sincronizado às " + new Date(payload.ts).toLocaleTimeString());
    }
    function setupSyncChannel() {
      if ("BroadcastChannel" in window) {
        syncChannel = new BroadcastChannel(SYNC_CHANNEL_NAME);
        syncChannel.onmessage = (ev) => {
          if (!ev.data || !ev.data.ts || ev.data.ts <= lastSyncTs) return;
          lastSyncTs = ev.data.ts;
          applySnapshot(ev.data.snapshot);
          renderTudo();
          updateSyncStatus("Atualizado a partir de outro dispositivo às " + new Date(ev.data.ts).toLocaleTimeString());
        };
        updateSyncStatus("Canal ativo");
      } else {
        updateSyncStatus("Browser sem BroadcastChannel. Usa export/import para sincronizar.");
      }
    }

    // Storage helpers
    function loadMovimentos() {
      try { return JSON.parse(localStorage.getItem(STORAGE_MAIN) || "[]"); }
      catch { return []; }
    }
    function saveMovimentos(arr) {
      localStorage.setItem(STORAGE_MAIN, JSON.stringify(arr));
      broadcastSync();
      queueSupabasePush();
    }
    function loadCategorias() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_CATS) ||
          '["Renda","Luz","Água","Telemóvel","Alimentação","Transportes","Lazer","Outros"]');
      } catch {
        return ["Renda","Luz","Água","Telemóvel","Alimentação","Transportes","Lazer","Outros"];
      }
    }
    function saveCategorias(arr) {
      localStorage.setItem(STORAGE_CATS, JSON.stringify(arr));
      broadcastSync();
      queueSupabasePush();
    }
    function loadDebitos() {
      try { return JSON.parse(localStorage.getItem(STORAGE_DEBITS) || "[]"); }
      catch { return []; }
    }
    function saveDebitos(arr) {
      localStorage.setItem(STORAGE_DEBITS, JSON.stringify(arr));
      broadcastSync();
      queueSupabasePush();
    }
    function loadMetas() {
      try { return JSON.parse(localStorage.getItem(STORAGE_GOALS) || "{}"); }
      catch { return {}; }
    }
    function saveMetas(obj) {
      localStorage.setItem(STORAGE_GOALS, JSON.stringify(obj));
      broadcastSync();
      queueSupabasePush();
    }
    function loadNotifState() {
      try { return JSON.parse(localStorage.getItem(STORAGE_NOTIF) || "{}"); }
      catch { return {}; }
    }
    function saveNotifState(obj) {
      localStorage.setItem(STORAGE_NOTIF, JSON.stringify(obj));
    }

    // Categorias UI
    function renderCategoriasUI() {
      const cats = loadCategorias();
      const select = document.getElementById("categoria");
      const list = document.getElementById("listaCategorias");
      if (select) {
        select.innerHTML = "";
        cats.forEach(c => {
          const op = document.createElement("option");
          op.value = c; op.textContent = c;
          select.appendChild(op);
        });
      }
      if (list) {
        list.innerHTML = "";
        cats.forEach(c => {
          const pill = document.createElement("span");
          pill.textContent = c;
          pill.className = "badge badge-pessoa";
          list.appendChild(pill);
        });
      }
    }

    // Débitos diretos UI
    function renderDebitosUI() {
      const sessionUser = getSessionUser();
      const tbody = document.getElementById("tabelaDebitos");
      if (!tbody) return;

      if (!sessionUser) {
        tbody.innerHTML = "";
        return;
      }

      const debitos = filterDataForUser(loadDebitos());
      tbody.innerHTML = "";
      debitos
        .slice()
        .sort((a,b) => (Number(a.dia)||0) - (Number(b.dia)||0))
        .forEach((d) => {
          const tr = document.createElement("tr");
          const valorNum = Number(d.valor) || 0;
          tr.innerHTML = `
            <td>${d.dia || ""}</td>
            <td>${d.descricao || ""}</td>
            <td><span class="badge badge-pessoa">${d.pessoa || ""}</span></td>
            <td>${formatCurrency(valorNum)}</td>
            <td><button class="btn-danger" data-dd-id="${d.id}">X</button></td>
          `;
          tbody.appendChild(tr);
        });

      tbody.querySelectorAll("button[data-dd-id]").forEach(btn => {
        btn.addEventListener("click", (ev) => {
          const ddId = ev.target.getAttribute("data-dd-id");
          const arr = loadDebitos();
          const idx = arr.findIndex(x => x.id === ddId);
          if (idx !== -1) arr.splice(idx,1);
          saveDebitos(arr);
          renderDebitosUI();
        });
      });
    }

    // Metas UI
    function renderMetasUI() {
      const metas = loadMetas();
      const mH = document.getElementById("metaHelder");
      const mN = document.getElementById("metaNamorada");
      const mC = document.getElementById("metaConjunto");
      const mP = document.getElementById("metaPoupanca");
      const notas = document.getElementById("planeamentoNotas");
      if (mH) mH.value = metas.metaHelder ?? "";
      if (mN) mN.value = metas.metaNamorada ?? "";
      if (mC) mC.value = metas.metaConjunto ?? "";
      if (mP) mP.value = metas.metaPoupanca ?? "";
      if (notas) notas.value = metas.planeamentoNotas ?? "";
    }

    // Saldo inicial persistente
    function loadSaldoInicial() {
      const raw = localStorage.getItem(STORAGE_SALDO);
      return raw ? Number(raw) || 0 : 0;
    }
    function saveSaldoInicial(v) {
      localStorage.setItem(STORAGE_SALDO, String(v));
      broadcastSync();
      queueSupabasePush();
    }

    function renderPessoaSelect(select, allowed) {
      if (!select) return;
      const current = select.value;
      select.innerHTML = "";
      allowed.forEach(p => {
        const op = document.createElement("option");
        op.value = p; op.textContent = p;
        select.appendChild(op);
      });
      if (!allowed.length) {
        const op = document.createElement("option");
        op.textContent = "Inicia sessão";
        select.appendChild(op);
        select.disabled = true;
      } else {
        select.disabled = false;
      }
      if (allowed.includes(current)) select.value = current;
    }

    function renderSessionUI() {
      const user = getSessionUser();
      const status = document.getElementById("sessionStatus");
      if (status) {
        status.innerHTML = user
          ? `Sessão ativa: <strong>${user.username}</strong> (${user.role}).`
          : "Nenhum utilizador autenticado.";
      }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) logoutBtn.style.display = user ? "inline-flex" : "none";

      const appContent = document.getElementById("appContent");
      if (appContent) appContent.style.display = user ? "block" : "none";

      if (!user) {
        // Proteção extra: limpa tabelas para evitar restos visuais de sessões anteriores
        ["tabelaBody","tabelaDebitos","resumoMensalBody","tabelaCategoriasBody","tabelaPessoasBody"]
          .forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ""; });
        ["metaHelderLabel","realHelderLabel","metaNamoradaLabel","realNamoradaLabel","metaConjuntoLabel","realConjuntoLabel","metaPoupancaLabel","realPoupancaLabel"]
          .forEach(id => { const el = document.getElementById(id); if (el) el.textContent = ""; });
        ["metaHelderBar","metaNamoradaBar","metaConjuntoBar","metaPoupancaBar"]
          .forEach(id => { const el = document.getElementById(id); if (el) el.style.width = "0%"; });
      }

      document.querySelectorAll('[data-admin-only="true"]').forEach(sec => {
        sec.style.display = (user && user.role === "admin") ? "block" : "none";
      });

      renderUserList();
      renderPermissionsUI();

      const allowed = allowedPessoas(user);
      renderPessoaSelect(document.getElementById("pessoa"), allowed);
      renderPessoaSelect(document.getElementById("ddPessoa"), allowed);
    }

    function renderUserList() {
      const list = document.getElementById("userList");
      if (!list) return;
      const user = getSessionUser();
      const admin = user && user.role === "admin";
      const users = loadUsers();
      list.innerHTML = "";
      users.forEach(u => {
        const pill = document.createElement("div");
        pill.className = "badge badge-pessoa";
        pill.style.display = "flex";
        pill.style.alignItems = "center";
        pill.style.gap = "0.35rem";
        pill.textContent = `${u.username} (${u.role})`;
        if (admin) {
          const resetBtn = document.createElement("button");
          resetBtn.textContent = "Password";
          resetBtn.className = "btn-secondary btn-small";
          resetBtn.addEventListener("click", () => {
            const nova = prompt(`Nova password para ${u.username}`);
            if (nova) {
              u.pass = simpleHash(nova);
              saveUsers(users);
              renderUserList();
            }
          });
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remover";
          removeBtn.className = "btn-danger";
          removeBtn.addEventListener("click", () => {
            if (u.username === "admin") return alert("Não podes remover o admin base.");
            const idx = users.findIndex(x => x.username === u.username);
            if (idx !== -1) {
              users.splice(idx,1);
              saveUsers(users);
              renderUserList();
            }
          });
          const actions = document.createElement("div");
          actions.style.display = "flex";
          actions.style.gap = "0.35rem";
          actions.appendChild(resetBtn);
          actions.appendChild(removeBtn);
          pill.appendChild(actions);
        }
        list.appendChild(pill);
      });
    }

    function renderPermissionsUI() {
      const status = document.getElementById("permissionsStatus");
      const settings = loadSettings();
      const allowH = !!settings.allowHelderConjunto;
      const allowG = !!settings.allowGoretiConjunto;
      if (status) {
        status.textContent = `Helder -> Conjunto: ${allowH ? "SIM" : "NÃO"} · Goreti -> Conjunto: ${allowG ? "SIM" : "NÃO"}. Conjunto está sempre visível para o Admin.`;
      }
    }

    // Tabela de movimentos
    function renderTabelaMovimentos() {
      const tbody = document.getElementById("tabelaBody");
      const sessionUser = getSessionUser();
      if (!tbody) return;

      if (!sessionUser) {
        tbody.innerHTML = "";
        return;
      }

      const all = loadMovimentos();
      const month = getCurrentMonth();
      const monthData = filterDataForUser(filterByMonth(all, month));
      tbody.innerHTML = "";

      monthData
        .slice()
        .sort((a,b) => (a.data || "").localeCompare(b.data || ""))
        .forEach(item => {
          const tr = document.createElement("tr");

          const tdData = document.createElement("td");
          tdData.textContent = item.data || "";
          tr.appendChild(tdData);

          const tdDesc = document.createElement("td");
          tdDesc.textContent = item.descricao || "";
          tr.appendChild(tdDesc);

          const tdPessoa = document.createElement("td");
          const pillPessoa = document.createElement("span");
          pillPessoa.textContent = item.pessoa || "";
          pillPessoa.className = "badge badge-pessoa";
          tdPessoa.appendChild(pillPessoa);
          tr.appendChild(tdPessoa);

          const tdTipo = document.createElement("td");
          const pillTipo = document.createElement("span");
          pillTipo.className = "badge " + (item.tipo === "receita" ? "badge-receita" : "badge-despesa");
          pillTipo.textContent = item.tipo === "receita" ? "Receita" : "Despesa";
          tdTipo.appendChild(pillTipo);
          tr.appendChild(tdTipo);

          const tdCat = document.createElement("td");
          tdCat.textContent = item.categoria || "";
          tr.appendChild(tdCat);

          const tdValor = document.createElement("td");
          const v = Number(item.valor) || 0;
          if (item.tipo === "receita") {
            tdValor.textContent = "+" + formatCurrency(v);
            tdValor.className = "amount-receita";
          } else {
            tdValor.textContent = "-" + formatCurrency(v);
            tdValor.className = "amount-despesa";
          }
          tr.appendChild(tdValor);

          const tdAcao = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "X";
          btn.className = "btn-danger";
          btn.addEventListener("click", () => {
            const allData = loadMovimentos();
            const idx = allData.findIndex(e => e.id === item.id);
            if (idx !== -1) {
              allData.splice(idx,1);
              saveMovimentos(allData);
              renderTudo();
            }
          });
          tdAcao.appendChild(btn);
          tr.appendChild(tdAcao);

          tbody.appendChild(tr);
        });
    }

      // Dashboard + tabelas
      function renderDashboardEGraficos() {
        const user = getSessionUser();
        const all = loadMovimentos();
        const month = getCurrentMonth();
        const monthData = filterDataForUser(filterByMonth(all, month));
        const saldoInicialInput = document.getElementById("saldoInicial");
        const saldoInicial = saldoInicialInput ? (Number(saldoInicialInput.value.replace(",", ".")) || 0) : 0;

        let totalDesp = 0;
        let totalRec = 0;

        const resumoBody = document.getElementById("resumoMensalBody");
        const catBody = document.getElementById("tabelaCategoriasBody");
        const pessoasBody = document.getElementById("tabelaPessoasBody");

        const setEmptyTables = (msg = "Sem dados") => {
          if (resumoBody) {
            resumoBody.innerHTML = `
              <tr><td>Despesas</td><td>—</td></tr>
              <tr><td>Receitas</td><td>—</td></tr>
              <tr><td>Poupança</td><td>—</td></tr>
              <tr><td>Saldo (com saldo inicial)</td><td>—</td></tr>
            `;
          }
          if (catBody) catBody.innerHTML = `<tr><td colspan="2">${msg}</td></tr>`;
          if (pessoasBody) pessoasBody.innerHTML = `<tr><td colspan="2">${msg}</td></tr>`;
        };

        if (!user) {
          ["totalReceitas","totalDespesas","saldoFinal","metaHelderLabel","metaNamoradaLabel","metaConjuntoLabel","metaPoupancaLabel"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = "—";
          });

          setEmptyTables("Faça login para ver os dados");
          return;
        }

        // Totais por pessoa (só despesas)
        const porPessoa = { Helder:0, Goreti:0, Conjunto:0 };

        // Despesas por categoria
        const porCategoria = {};

        monthData.forEach(item => {
          const v = Number(item.valor) || 0;
          if (item.tipo === "despesa") {
            totalDesp += v;
            porPessoa[item.pessoa] = (porPessoa[item.pessoa] || 0) + v;
            porCategoria[item.categoria] = (porCategoria[item.categoria] || 0) + v;
          } else if (item.tipo === "receita") {
            totalRec += v;
          }
        });

        const poupanca = totalRec - totalDesp;
        const saldo = saldoInicial + poupanca;

        document.getElementById("totalDespesas").textContent = "-" + formatCurrency(totalDesp);
        document.getElementById("totalReceitas").textContent = formatCurrency(totalRec);
        document.getElementById("poupancaMes").textContent = formatCurrency(poupanca);
        document.getElementById("saldoMes").textContent = formatCurrency(saldo);

        if (resumoBody) {
          resumoBody.innerHTML = `
            <tr><td>Despesas</td><td>- ${formatCurrency(totalDesp)}</td></tr>
            <tr><td>Receitas</td><td>${formatCurrency(totalRec)}</td></tr>
            <tr><td>Poupança</td><td>${formatCurrency(poupanca)}</td></tr>
            <tr><td>Saldo (com saldo inicial)</td><td>${formatCurrency(saldo)}</td></tr>
          `;
        }

        const catEntries = Object.entries(porCategoria).sort((a,b) => (b[1]||0) - (a[1]||0));
        if (catBody) {
          catBody.innerHTML = catEntries.length
            ? catEntries.map(([cat, val]) => `<tr><td>${cat || "(sem categoria)"}</td><td>${formatCurrency(val)}</td></tr>`).join("")
            : `<tr><td colspan="2">Sem despesas</td></tr>`;
        }

        const pessoasLista = [
          ["Helder", porPessoa["Helder"] || 0],
          ["Goreti", porPessoa["Goreti"] || 0],
          ["Conjunto", porPessoa["Conjunto"] || 0]
        ];
        if (pessoasBody) {
          pessoasBody.innerHTML = pessoasLista
            .map(([nome, val]) => `<tr><td>${nome}</td><td>${formatCurrency(val)}</td></tr>`)
            .join("");
        }

        // Metas/progresso
        const metas = loadMetas();
        const metaH = Number(metas.metaHelder || 0);
        const metaN = Number(metas.metaNamorada || 0);
        const metaC = Number(metas.metaConjunto || 0);
        const metaP = Number(metas.metaPoupanca || 0);

        const realH = porPessoa["Helder"] || 0;
        const realN = porPessoa["Goreti"] || 0;
        const realC = porPessoa["Conjunto"] || 0;
        const realP = poupanca;

        const setMetaRow = (metaValue, realValue, metaLabelId, realLabelId, barId, invertColors=false) => {
          const mLabel = document.getElementById(metaLabelId);
          const rLabel = document.getElementById(realLabelId);
          const bar = document.getElementById(barId);
          if (mLabel) mLabel.textContent = "Meta: " + (metaValue ? formatCurrency(metaValue) : "-");
          if (rLabel) rLabel.textContent = "Real: " + formatCurrency(realValue);
          if (bar) {
            let perc = metaValue ? (invertColors ? (realValue/metaValue)*100 : (realValue/metaValue)*100) : 0;
            if (!isFinite(perc)) perc = 0;
            if (perc > 100) perc = 100;
            bar.style.width = perc.toFixed(0) + "%";
          }
        };

        setMetaRow(metaH, realH, "metaHelderLabel", "realHelderLabel", "metaHelderBar");
        setMetaRow(metaN, realN, "metaNamoradaLabel", "realNamoradaLabel", "metaNamoradaBar");
        setMetaRow(metaC, realC, "metaConjuntoLabel", "realConjuntoLabel", "metaConjuntoBar");
        setMetaRow(metaP, realP, "metaPoupancaLabel", "realPoupancaLabel", "metaPoupancaBar", true);
      }

    // Backup
    function exportBackup() {
      const payload = {
        movimentos: loadMovimentos(),
        categorias: loadCategorias(),
        debitos: loadDebitos(),
        metas: loadMetas(),
        saldoInicial: loadSaldoInicial(),
        users: loadUsers(),
        settings: loadSettings()
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = new Date();
      const stamp = today.toISOString().slice(0,10);
      a.href = url;
      a.download = "despesas_backup_" + stamp + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importBackup(file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.movimentos) saveMovimentos(data.movimentos);
          if (data.categorias) saveCategorias(data.categorias);
          if (data.debitos) saveDebitos(data.debitos);
          if (data.metas) saveMetas(data.metas);
          if (typeof data.saldoInicial !== "undefined") saveSaldoInicial(data.saldoInicial);
          if (data.users) saveUsers(data.users);
          if (data.settings) saveSettings(data.settings);
          logoutUser();
          alert("Backup importado com sucesso!");
          renderTudo();
        } catch (e) {
          alert("Ficheiro de backup inválido.");
        }
      };
      reader.readAsText(file);
    }

    // Exportação CSV / Google Sheets
    function movimentosToCSV() {
      const rows = [["Data","Descrição","Pessoa","Tipo","Categoria","Valor (€)"]];
      const movimentos = filterByMonth(filterDataForUser(loadMovimentos()), getCurrentMonth());
      movimentos.forEach(m => {
        rows.push([
          m.data || "",
          m.descricao || "",
          m.pessoa || "",
          m.tipo || "",
          m.categoria || "",
          Number(m.valor || 0).toString().replace(".", ",")
        ]);
      });
      return rows.map(r => r.map(val => `"${String(val).replace(/"/g,'""')}"`).join(";"))
                 .join("\n");
    }

    function exportMovimentosCSV() {
      const csv = movimentosToCSV();
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `despesas_${getCurrentMonth()}_csv.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function copyMovimentosToSheets() {
      const csv = movimentosToCSV();
      try {
        await navigator.clipboard.writeText(csv);
        alert("Copiado! Abre o Google Sheets e cola numa folha vazia.");
      } catch {
        alert("Não consegui aceder à área de transferência.");
      }
    }

    // Notificações de débitos diretos
    function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") {
        try { Notification.requestPermission(); } catch {}
      }
    }

    function checkDebitosAndNotify() {
      const debitos = loadDebitos();
      if (!debitos.length) return;
      const notifArea = document.getElementById("notifArea");
      const notifList = document.getElementById("notifList");
      if (!notifArea || !notifList) return;

      const now = new Date();
      const todayDay = now.getDate();
      const todayISO = now.toISOString().slice(0,10);
      const notifState = loadNotifState();

      const todays = debitos.filter(d => Number(d.dia) === todayDay);
      notifList.innerHTML = "";

      if (todays.length) {
        todays.forEach(d => {
          // notificar apenas uma vez por dia
          if (notifState[d.id] === todayISO) return;
          const pill = document.createElement("span");
          pill.className = "notif-pill";
          pill.textContent = `${d.dia} · ${d.descricao} · ${formatCurrency(d.valor)} (${d.pessoa})`;
          notifList.appendChild(pill);

          // Notification API (só se permitido e página aberta)
          if ("Notification" in window && Notification.permission === "granted") {
            try {
              new Notification("Débito direto hoje", {
                body: `${d.descricao} · ${formatCurrency(d.valor)} · ${d.pessoa}`,
              });
            } catch {}
          }

          notifState[d.id] = todayISO;
        });

        if (notifList.children.length) {
          notifArea.style.display = "flex";
        } else {
          notifArea.style.display = "none";
        }
        saveNotifState(notifState);
      } else {
        notifArea.style.display = "none";
      }
    }

    function renderTudo() {
      // sincronizar mês default
      const monthInput = document.getElementById("monthFilter");
      if (monthInput && !monthInput.value) {
        monthInput.value = getCurrentMonth();
      }

      renderSessionUI();
      renderCategoriasUI();
      renderDebitosUI();
      renderTabelaMovimentos();
      renderDashboardEGraficos();
      renderMetasUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      ensureDefaultUsers();
      setupSyncChannel();

      // Obriga um novo login a cada abertura para não herdar sessões antigas
      logoutUser();

      // Supabase config UI
      const supCfg = loadSupabaseConfig();
      const supUrlInput = document.getElementById("supabaseUrl");
      const supAnonInput = document.getElementById("supabaseAnon");
      const supEmailInput = document.getElementById("supabaseEmail");
      const supPassInput = document.getElementById("supabasePassword");
      const supEnable = document.getElementById("supabaseEnable");
      const saveSupBtn = document.getElementById("saveSupabaseCfg");
      const pullSupBtn = document.getElementById("pullSupabase");
      const pushSupBtn = document.getElementById("pushSupabase");
      const logoutSupBtn = document.getElementById("logoutSupabase");

      if (supUrlInput) supUrlInput.value = supCfg.url || "";
      if (supAnonInput) supAnonInput.value = supCfg.anon || "";
      if (supEmailInput) supEmailInput.value = supCfg.email || "";
      if (supPassInput) supPassInput.value = supCfg.password || "";
      if (supEnable) supEnable.checked = !!supCfg.enabled;
      if (supabaseConfigEnabled(supCfg)) {
        setSupabaseStatus("Configuração Supabase carregada. Faz login interno e carrega Pull para trazer os dados.");
      }

      if (saveSupBtn) {
        saveSupBtn.addEventListener("click", () => {
          const cfg = {
            url: (supUrlInput?.value || "").trim(),
            anon: (supAnonInput?.value || "").trim(),
            email: (supEmailInput?.value || "").trim(),
            password: supPassInput?.value || "",
            enabled: !!supEnable?.checked
          };
          saveSupabaseConfig(cfg);
          supabaseSession = null;
          setSupabaseStatus(cfg.enabled
            ? "Configuração guardada. Usa Pull para carregar do Supabase e Push ao gravar."
            : "Supabase desativado. Guarda novamente para voltar a ativar.");
        });
      }
      if (pullSupBtn) pullSupBtn.addEventListener("click", () => supabasePullLatest());
      if (pushSupBtn) pushSupBtn.addEventListener("click", () => supabasePushLatest());
      if (logoutSupBtn) logoutSupBtn.addEventListener("click", () => { supabaseLogout(); });

      // saldo inicial
      const saldoInicialInput = document.getElementById("saldoInicial");
      if (saldoInicialInput) {
        saldoInicialInput.value = loadSaldoInicial();
        saldoInicialInput.addEventListener("change", () => {
          const v = Number(saldoInicialInput.value.replace(",", ".")) || 0;
          saveSaldoInicial(v);
          renderDashboardEGraficos();
        });
      }

      const monthInput = document.getElementById("monthFilter");
      if (monthInput) {
        monthInput.value = getCurrentMonth();
        monthInput.addEventListener("change", () => {
          renderTabelaMovimentos();
          renderDashboardEGraficos();
        });
      }

      // Autenticação
      const loginBtn = document.getElementById("loginBtn");
      if (loginBtn) {
        loginBtn.addEventListener("click", () => {
          const u = (document.getElementById("loginUsername").value || "").trim();
          const p = document.getElementById("loginPassword").value || "";
          const users = loadUsers();
          const found = users.find(user => user.username === u);
          if (found && found.pass === simpleHash(p)) {
            setSessionUser(found.username);
            document.getElementById("loginPassword").value = "";
            renderTudo();
            supabaseAutoPullAfterLogin();
          } else {
            alert("Utilizador ou password inválidos.");
          }
        });
      }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          logoutUser();
          renderTudo();
        });
      }

      // Criar utilizador (admin)
      const addUserBtn = document.getElementById("addUserBtn");
      if (addUserBtn) {
        addUserBtn.addEventListener("click", () => {
          const current = getSessionUser();
          if (!current || current.role !== "admin") return alert("Apenas o admin pode criar utilizadores.");
          const name = (document.getElementById("newUserName").value || "").trim();
          const pass = document.getElementById("newUserPass").value || "";
          const role = document.getElementById("newUserRole").value;
          if (!name || !pass) return alert("Preenche utilizador e password.");
          const users = loadUsers();
          if (users.some(u => u.username === name)) return alert("Já existe um utilizador com esse nome.");
          users.push({ username:name, role, pass: simpleHash(pass) });
          saveUsers(users);
          document.getElementById("newUserName").value = "";
          document.getElementById("newUserPass").value = "";
          renderSessionUI();
        });
      }

      // Permissões Conjunto
      const adminOnlyBtn = document.getElementById("adminOnlyConjunto");
      if (adminOnlyBtn) {
        adminOnlyBtn.addEventListener("click", () => {
          const user = getSessionUser();
          if (!user || user.role !== "admin") return alert("Só o admin pode alterar isto.");
          const settings = loadSettings();
          settings.allowHelderConjunto = false;
          settings.allowGoretiConjunto = false;
          saveSettings(settings);
          renderSessionUI();
        });
      }
      const toggleHelder = document.getElementById("toggleHelderConjunto");
      if (toggleHelder) {
        toggleHelder.addEventListener("click", () => {
          const user = getSessionUser();
          if (!user || user.role !== "admin") return alert("Só o admin pode alterar isto.");
          const settings = loadSettings();
          settings.allowHelderConjunto = !settings.allowHelderConjunto;
          saveSettings(settings);
          renderSessionUI();
        });
      }
      const toggleGoreti = document.getElementById("toggleGoretiConjunto");
      if (toggleGoreti) {
        toggleGoreti.addEventListener("click", () => {
          const user = getSessionUser();
          if (!user || user.role !== "admin") return alert("Só o admin pode alterar isto.");
          const settings = loadSettings();
          settings.allowGoretiConjunto = !settings.allowGoretiConjunto;
          saveSettings(settings);
          renderSessionUI();
        });
      }

      // Botão novo movimento
      const addBtn = document.getElementById("addBtn");
      if (addBtn) {
        addBtn.addEventListener("click", () => {
          const sessionUser = getSessionUser();
          if (!sessionUser) return alert("Faz login para registar movimentos.");
          const data = document.getElementById("data").value || new Date().toISOString().slice(0,10);
          const desc = document.getElementById("descricao").value.trim();
          const valor = Number((document.getElementById("valor").value || "").replace(",", "."));
          const tipo = document.getElementById("tipo").value;
          const pessoa = document.getElementById("pessoa").value;
          const categoria = document.getElementById("categoria").value;

          if (!allowedPessoas(sessionUser).includes(pessoa)) {
            return alert("Sem permissão para registar para essa pessoa.");
          }

          if (!desc || isNaN(valor)) {
            alert("Preenche pelo menos a descrição e o valor.");
            return;
          }
          const all = loadMovimentos();
          all.push({
            id: Date.now().toString(16) + Math.random().toString(16).slice(2),
            data,
            descricao: desc,
            valor,
            tipo,
            pessoa,
            categoria
          });
          saveMovimentos(all);

          document.getElementById("descricao").value = "";
          document.getElementById("valor").value = "";

          renderTabelaMovimentos();
          renderDashboardEGraficos();
        });
      }

      // Botão novas categorias
      const addCatBtn = document.getElementById("addCategoria");
      if (addCatBtn) {
        addCatBtn.addEventListener("click", () => {
          const input = document.getElementById("novaCategoria");
          const c = (input.value || "").trim();
          if (!c) return;
          const cats = loadCategorias();
          if (!cats.includes(c)) {
            cats.push(c);
            saveCategorias(cats);
          }
          input.value = "";
          renderCategoriasUI();
        });
      }

      // Botão adicionar débito direto
      const addDebitoBtn = document.getElementById("addDebitoBtn");
      if (addDebitoBtn) {
        addDebitoBtn.addEventListener("click", () => {
          const sessionUser = getSessionUser();
          if (!sessionUser) return alert("Faz login para registar débitos diretos.");
          const desc = document.getElementById("ddDescricao").value.trim();
          const valor = Number((document.getElementById("ddValor").value || "").replace(",", "."));
          const dia = Number(document.getElementById("ddDia").value);
          const pessoa = document.getElementById("ddPessoa").value;
          if (!allowedPessoas(sessionUser).includes(pessoa)) return alert("Sem permissão para essa pessoa.");
          if (!desc || isNaN(valor) || !dia || dia < 1 || dia > 31) {
            alert("Preenche descrição, valor e um dia válido (1-31).");
            return;
          }
          const arr = loadDebitos();
          arr.push({
            id: Date.now().toString(16) + Math.random().toString(16).slice(2),
            descricao: desc,
            valor,
            dia,
            pessoa
          });
          saveDebitos(arr);
          document.getElementById("ddDescricao").value = "";
          document.getElementById("ddValor").value = "";
          document.getElementById("ddDia").value = "";
          renderDebitosUI();
          checkDebitosAndNotify();
        });
      }

      // Botão guardar metas
      const saveMetasBtn = document.getElementById("saveMetasBtn");
      if (saveMetasBtn) {
        saveMetasBtn.addEventListener("click", () => {
          const metas = {
            metaHelder: Number((document.getElementById("metaHelder").value || "").replace(",", ".")) || 0,
            metaNamorada: Number((document.getElementById("metaNamorada").value || "").replace(",", ".")) || 0,
            metaConjunto: Number((document.getElementById("metaConjunto").value || "").replace(",", ".")) || 0,
            metaPoupanca: Number((document.getElementById("metaPoupanca").value || "").replace(",", ".")) || 0,
            planeamentoNotas: document.getElementById("planeamentoNotas").value || ""
          };
          saveMetas(metas);
          renderDashboardEGraficos();
          alert("Metas guardadas!");
        });
      }

      // Backup
      const exportBtn = document.getElementById("exportBackupBtn");
      if (exportBtn) {
        exportBtn.addEventListener("click", exportBackup);
      }
      const backupInput = document.getElementById("backupFile");
      if (backupInput) {
        backupInput.addEventListener("change", (ev) => {
          if (ev.target.files && ev.target.files[0]) {
            importBackup(ev.target.files[0]);
            ev.target.value = "";
          }
        });
      }

      const exportCsvBtn = document.getElementById("exportCsvBtn");
      if (exportCsvBtn) exportCsvBtn.addEventListener("click", exportMovimentosCSV);
      const copySheetsBtn = document.getElementById("copySheetsBtn");
      if (copySheetsBtn) copySheetsBtn.addEventListener("click", copyMovimentosToSheets);

      const forceSyncBtn = document.getElementById("forceSyncBtn");
      if (forceSyncBtn) forceSyncBtn.addEventListener("click", () => {
        broadcastSync();
        renderTudo();
      });

      // Notificação barra fechar
      const notifClose = document.getElementById("notifClose");
      if (notifClose) {
        notifClose.addEventListener("click", () => {
          const notifArea = document.getElementById("notifArea");
          if (notifArea) notifArea.style.display = "none";
        });
      }

      // Render inicial
      renderTudo();

      // Notificações
      requestNotificationPermission();
      checkDebitosAndNotify();
      setInterval(checkDebitosAndNotify, 60 * 1000); // verifica a cada minuto
    });
  </script>
</body>
</html>
