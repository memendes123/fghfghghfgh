
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Despesas Dashboard PRO+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      background: radial-gradient(circle at top left,#22c55e,#0f172a 55%);
      padding: 1.2rem 1.5rem 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.35rem;
    }
    header p {
      margin: 0.25rem 0 0 0;
      font-size: 0.85rem;
      opacity: 0.8;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem;
    }
    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 1rem 1.1rem;
      margin-bottom: 1rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.40);
      border: 1px solid rgba(148,163,184,0.35);
    }
    h2 {
      margin-top: 0;
      font-size: 1.05rem;
    }
    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.15rem;
    }
    input, select, textarea, button {
      font-family: inherit;
      font-size: 0.9rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    select,
    textarea {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 1.1rem;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: none;
    }
    .btn-primary {
      background: #22c55e;
      color: #052e16;
      box-shadow: 0 12px 30px rgba(34,197,94,0.40);
    }
    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn-danger {
      background: #ef4444;
      color: #fef2f2;
      font-size: 0.78rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .btn-small {
      font-size: 0.78rem;
      padding: 0.3rem 0.65rem;
    }
    .flex {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 160px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .stat {
      padding: 0.7rem 0.8rem;
      border-radius: 12px;
      background: radial-gradient(circle at top left,#0b1120,#020617);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .stat-title {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.15rem;
    }
    .stat-value {
      font-size: 1.05rem;
      font-weight: 700;
    }
    .stat-neg { color: #f97373; }
    .stat-pos { color: #4ade80; }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      gap: 0.25rem;
    }
    .badge-despesa {
      background: rgba(248,113,113,0.15);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.6);
    }
    .badge-receita {
      background: rgba(52,211,153,0.12);
      color: #bbf7d0;
      border: 1px solid rgba(52,211,153,0.6);
    }
    .badge-pessoa {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
      border: 1px solid rgba(59,130,246,0.6);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.83rem;
    }
    th, td {
      padding: 0.45rem 0.4rem;
      border-bottom: 1px solid #1f2933;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: rgba(15,23,42,0.9);
      font-weight: 600;
      font-size: 0.78rem;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.75);
    }
    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.4);
    }
    .amount-despesa {
      color: #fecaca;
      font-weight: 600;
    }
    .amount-receita {
      color: #bbf7d0;
      font-weight: 600;
    }
    .pill-progress {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 0.2rem;
    }
    .pill-progress-inner {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg,#22c55e,#a3e635);
      width: 0%;
      transition: width 0.25s ease;
    }
    .notif-bar {
      margin: 0.5rem auto;
      max-width: 1100px;
      padding: 0.55rem 0.75rem;
      border-radius: 999px;
      background: rgba(250,204,21,0.15);
      border: 1px solid rgba(250,204,21,0.7);
      color: #facc15;
      font-size: 0.78rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .notif-bar strong { font-weight: 700; }
    .notif-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.78rem;
    }
    .notif-pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(250,204,21,0.12);
      border: 1px dashed rgba(250,204,21,0.5);
    }
    @media (max-width: 720px) {
      th:nth-child(2),
      td:nth-child(2) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Despesas Dashboard PRO+</h1>
    <p>Despesas Helder • Namorada • Conjunto · Débitos diretos · Metas · Planeamento · Backup</p>
  </header>

  <div id="notifArea" class="notif-bar">
    <div class="notif-list" id="notifList"></div>
    <button id="notifClose" class="btn-secondary btn-small" style="border-radius:999px;">Fechar</button>
  </div>

  <main>

    <!-- DASHBOARD -->
    <section class="card">
      <div class="flex-between">
        <h2>Dashboard mensal</h2>
        <div class="flex" style="align-items:flex-end;">
          <div class="col" style="flex:0 0 140px;">
            <label for="monthFilter">Mês</label>
            <input type="month" id="monthFilter">
          </div>
          <div class="col" style="flex:0 0 140px;">
            <label for="saldoInicial">Saldo inicial (€)</label>
            <input type="number" id="saldoInicial" step="0.01" value="0">
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-title">Saldo do mês</div>
          <div class="stat-value" id="saldoMes">0,00 €</div>
        </div>
        <div class="stat">
          <div class="stat-title">Total despesas</div>
          <div class="stat-value stat-neg" id="totalDespesas">0,00 €</div>
        </div>
        <div class="stat">
          <div class="stat-title">Total receitas</div>
          <div class="stat-value stat-pos" id="totalReceitas">0,00 €</div>
        </div>
        <div class="stat">
          <div class="stat-title">Poupança (receitas - despesas)</div>
          <div class="stat-value" id="poupancaMes">0,00 €</div>
        </div>
      </div>

      <div class="stats" style="margin-top:1rem;">
        <div class="stat">
          <div class="stat-title">Helder · meta vs real</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaHelderLabel">Meta: - €</span>
            <span id="realHelderLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaHelderBar" class="pill-progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="stat-title">Namorada · meta vs real</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaNamoradaLabel">Meta: - €</span>
            <span id="realNamoradaLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaNamoradaBar" class="pill-progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="stat-title">Conjunto · meta vs real</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaConjuntoLabel">Meta: - €</span>
            <span id="realConjuntoLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaConjuntoBar" class="pill-progress-inner"></div></div>
        </div>
        <div class="stat">
          <div class="stat-title">Meta de poupança · progresso</div>
          <div class="flex-between" style="font-size:0.78rem;">
            <span id="metaPoupancaLabel">Meta: - €</span>
            <span id="realPoupancaLabel">Real: - €</span>
          </div>
          <div class="pill-progress"><div id="metaPoupancaBar" class="pill-progress-inner"></div></div>
        </div>
      </div>

      <div style="margin-top:1.1rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:0.75rem;">
        <canvas id="chartDespesas"></canvas>
        <canvas id="chartCategorias"></canvas>
        <canvas id="chartPorPessoa"></canvas>
      </div>
    </section>

    <!-- NOVO MOVIMENTO -->
    <section class="card">
      <div class="flex-between">
        <h2>Novo movimento (despesa / receita)</h2>
        <small style="color:#9ca3af;">Guardado automaticamente neste dispositivo (localStorage)</small>
      </div>
      <div class="flex">
        <div class="col">
          <label for="data">Data</label>
          <input type="date" id="data">
        </div>
        <div class="col" style="flex:2 1 220px;">
          <label for="descricao">Descrição</label>
          <input type="text" id="descricao" placeholder="Ex: renda, luz, salário...">
        </div>
        <div class="col">
          <label for="valor">Valor (€)</label>
          <input type="number" id="valor" step="0.01">
        </div>
      </div>
      <div class="flex" style="margin-top:0.65rem;">
        <div class="col">
          <label for="tipo">Tipo</label>
          <select id="tipo">
            <option value="despesa">Despesa</option>
            <option value="receita">Receita</option>
          </select>
        </div>
        <div class="col">
          <label for="pessoa">Pessoa</label>
          <select id="pessoa">
            <option value="Helder">Helder</option>
            <option value="Namorada">Namorada</option>
            <option value="Conjunto">Conjunto</option>
          </select>
        </div>
        <div class="col">
          <label for="categoria">Categoria</label>
          <select id="categoria"></select>
        </div>
      </div>
      <div style="margin-top:0.8rem; text-align:right;">
        <button class="btn-primary" id="addBtn">Adicionar</button>
      </div>
    </section>

    <!-- DÉBITOS DIRETOS -->
    <section class="card">
      <div class="flex-between">
        <h2>Débitos diretos (mensais)</h2>
        <small style="color:#9ca3af;">Recebes aviso visual e (se possível) notificação no dia do débito</small>
      </div>
      <div class="flex">
        <div class="col">
          <label for="ddDescricao">Descrição</label>
          <input type="text" id="ddDescricao" placeholder="Ex: Renda, Netflix, Seguro...">
        </div>
        <div class="col">
          <label for="ddValor">Valor (€)</label>
          <input type="number" id="ddValor" step="0.01">
        </div>
        <div class="col">
          <label for="ddDia">Dia do mês</label>
          <input type="number" id="ddDia" min="1" max="31" placeholder="Ex: 5">
        </div>
        <div class="col">
          <label for="ddPessoa">Pessoa</label>
          <select id="ddPessoa">
            <option value="Helder">Helder</option>
            <option value="Namorada">Namorada</option>
            <option value="Conjunto">Conjunto</option>
          </select>
        </div>
      </div>
      <div style="margin-top:0.7rem; text-align:right;">
        <button class="btn-primary btn-small" id="addDebitoBtn">Adicionar débito direto</button>
      </div>
      <div style="margin-top:0.8rem; max-height:190px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Dia</th>
              <th>Descrição</th>
              <th>Pessoa</th>
              <th>Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tabelaDebitos"></tbody>
        </table>
      </div>
    </section>

    <!-- METAS & PLANEAMENTO -->
    <section class="card">
      <h2>Metas & planeamento</h2>
      <div class="flex">
        <div class="col">
          <label for="metaHelder">Meta despesas Helder / mês (€)</label>
          <input type="number" id="metaHelder" step="0.01" placeholder="Ex: 600">
        </div>
        <div class="col">
          <label for="metaNamorada">Meta despesas Namorada / mês (€)</label>
          <input type="number" id="metaNamorada" step="0.01" placeholder="Ex: 400">
        </div>
        <div class="col">
          <label for="metaConjunto">Meta despesas Conjunto / mês (€)</label>
          <input type="number" id="metaConjunto" step="0.01" placeholder="Ex: 500">
        </div>
        <div class="col">
          <label for="metaPoupanca">Meta poupança / mês (€)</label>
          <input type="number" id="metaPoupanca" step="0.01" placeholder="Ex: 300">
        </div>
      </div>
      <div style="margin-top:0.8rem;">
        <label for="planeamentoNotas">Planeamento / notas para este ano</label>
        <textarea id="planeamentoNotas" placeholder="Ex: pagar dívida X até março, guardar para férias em agosto, etc."></textarea>
      </div>
      <div style="margin-top:0.7rem; text-align:right;">
        <button class="btn-primary btn-small" id="saveMetasBtn">Guardar metas & planeamento</button>
      </div>
    </section>

    <!-- CATEGORIAS PERSONALIZADAS -->
    <section class="card">
      <div class="flex-between">
        <h2>Categorias personalizadas</h2>
        <small style="color:#9ca3af;">Adiciona as tuas próprias categorias de despesa/receita</small>
      </div>
      <div class="flex" style="align-items:flex-end;">
        <div class="col" style="flex:2 1 220px;">
          <label for="novaCategoria">Nova categoria</label>
          <input id="novaCategoria" placeholder="Ex: Gatos, Gaming, Subscripções...">
        </div>
        <div class="col" style="flex:0 0 120px;">
          <button class="btn-primary btn-small" id="addCategoria">Adicionar</button>
        </div>
      </div>
      <div style="margin-top:0.7rem; font-size:0.82rem;">
        <strong>Categorias ativas:</strong>
        <div id="listaCategorias" style="margin-top:0.4rem; display:flex; flex-wrap:wrap; gap:0.35rem;"></div>
      </div>
    </section>

    <!-- BACKUP -->
    <section class="card">
      <div class="flex-between">
        <h2>Backup & recuperação</h2>
        <small style="color:#9ca3af;">Exporta tudo para um ficheiro .json e guarda no Google Drive / e-mail</small>
      </div>
      <div class="flex" style="align-items:center; margin-top:0.6rem;">
        <div class="col" style="flex:0 0 180px;">
          <button class="btn-secondary btn-small" id="exportBackupBtn">Exportar backup (.json)</button>
        </div>
        <div class="col" style="flex:0 0 220px;">
          <label for="backupFile">Importar backup (.json)</label>
          <input type="file" id="backupFile" accept="application/json">
        </div>
        <div class="col" style="font-size:0.78rem; color:#9ca3af;">
          Dica: guarda o backup automaticamente no Google Drive (sincronizado) para não perderes nada.
        </div>
      </div>
    </section>

    <!-- LISTA DE MOVIMENTOS -->
    <section class="card">
      <div class="flex-between">
        <h2>Movimentos do mês</h2>
        <small style="color:#9ca3af;">A lista respeita o mês escolhido no dashboard</small>
      </div>
      <div style="max-height:260px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Pessoa</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tabelaBody"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    const STORAGE_MAIN   = "despesasPRO_v2";
    const STORAGE_CATS   = "categoriasPRO_v2";
    const STORAGE_DEBITS = "debitosPRO_v2";
    const STORAGE_GOALS  = "metasPRO_v2";
    const STORAGE_NOTIF  = "notifPRO_v2";
    const STORAGE_SALDO  = "saldoInicialPRO_v2";

    // Utils
    function formatCurrency(value) {
      const n = Number(value) || 0;
      return n.toLocaleString("pt-PT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    }
    function getCurrentMonth() {
      const input = document.getElementById("monthFilter");
      if (input && input.value) return input.value;
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const year = today.getFullYear();
      return year + "-" + month;
    }
    function filterByMonth(arr, monthStr) {
      return arr.filter(item => item.data && item.data.startsWith(monthStr));
    }

    // Storage helpers
    function loadMovimentos() {
      try { return JSON.parse(localStorage.getItem(STORAGE_MAIN) || "[]"); }
      catch { return []; }
    }
    function saveMovimentos(arr) {
      localStorage.setItem(STORAGE_MAIN, JSON.stringify(arr));
    }
    function loadCategorias() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_CATS) ||
          '["Renda","Luz","Água","Telemóvel","Alimentação","Transportes","Lazer","Outros"]');
      } catch {
        return ["Renda","Luz","Água","Telemóvel","Alimentação","Transportes","Lazer","Outros"];
      }
    }
    function saveCategorias(arr) {
      localStorage.setItem(STORAGE_CATS, JSON.stringify(arr));
    }
    function loadDebitos() {
      try { return JSON.parse(localStorage.getItem(STORAGE_DEBITS) || "[]"); }
      catch { return []; }
    }
    function saveDebitos(arr) {
      localStorage.setItem(STORAGE_DEBITS, JSON.stringify(arr));
    }
    function loadMetas() {
      try { return JSON.parse(localStorage.getItem(STORAGE_GOALS) || "{}"); }
      catch { return {}; }
    }
    function saveMetas(obj) {
      localStorage.setItem(STORAGE_GOALS, JSON.stringify(obj));
    }
    function loadNotifState() {
      try { return JSON.parse(localStorage.getItem(STORAGE_NOTIF) || "{}"); }
      catch { return {}; }
    }
    function saveNotifState(obj) {
      localStorage.setItem(STORAGE_NOTIF, JSON.stringify(obj));
    }

    // Categorias UI
    function renderCategoriasUI() {
      const cats = loadCategorias();
      const select = document.getElementById("categoria");
      const list = document.getElementById("listaCategorias");
      if (select) {
        select.innerHTML = "";
        cats.forEach(c => {
          const op = document.createElement("option");
          op.value = c; op.textContent = c;
          select.appendChild(op);
        });
      }
      if (list) {
        list.innerHTML = "";
        cats.forEach(c => {
          const pill = document.createElement("span");
          pill.textContent = c;
          pill.className = "badge badge-pessoa";
          list.appendChild(pill);
        });
      }
    }

    // Débitos diretos UI
    function renderDebitosUI() {
      const debitos = loadDebitos();
      const tbody = document.getElementById("tabelaDebitos");
      if (!tbody) return;
      tbody.innerHTML = "";
      debitos
        .slice()
        .sort((a,b) => (Number(a.dia)||0) - (Number(b.dia)||0))
        .forEach((d, idx) => {
          const tr = document.createElement("tr");
          const valorNum = Number(d.valor) || 0;
          tr.innerHTML = `
            <td>${d.dia || ""}</td>
            <td>${d.descricao || ""}</td>
            <td><span class="badge badge-pessoa">${d.pessoa || ""}</span></td>
            <td>${formatCurrency(valorNum)}</td>
            <td><button class="btn-danger" data-dd-index="${idx}">X</button></td>
          `;
          tbody.appendChild(tr);
        });

      tbody.querySelectorAll("button[data-dd-index]").forEach(btn => {
        btn.addEventListener("click", (ev) => {
          const idx = Number(ev.target.getAttribute("data-dd-index"));
          const arr = loadDebitos();
          arr.splice(idx,1);
          saveDebitos(arr);
          renderDebitosUI();
        });
      });
    }

    // Metas UI
    function renderMetasUI() {
      const metas = loadMetas();
      const mH = document.getElementById("metaHelder");
      const mN = document.getElementById("metaNamorada");
      const mC = document.getElementById("metaConjunto");
      const mP = document.getElementById("metaPoupanca");
      const notas = document.getElementById("planeamentoNotas");
      if (mH) mH.value = metas.metaHelder ?? "";
      if (mN) mN.value = metas.metaNamorada ?? "";
      if (mC) mC.value = metas.metaConjunto ?? "";
      if (mP) mP.value = metas.metaPoupanca ?? "";
      if (notas) notas.value = metas.planeamentoNotas ?? "";
    }

    // Saldo inicial persistente
    function loadSaldoInicial() {
      const raw = localStorage.getItem(STORAGE_SALDO);
      return raw ? Number(raw) || 0 : 0;
    }
    function saveSaldoInicial(v) {
      localStorage.setItem(STORAGE_SALDO, String(v));
    }

    // Tabela de movimentos
    function renderTabelaMovimentos() {
      const all = loadMovimentos();
      const month = getCurrentMonth();
      const monthData = filterByMonth(all, month);
      const tbody = document.getElementById("tabelaBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      monthData
        .slice()
        .sort((a,b) => (a.data || "").localeCompare(b.data || ""))
        .forEach(item => {
          const tr = document.createElement("tr");

          const tdData = document.createElement("td");
          tdData.textContent = item.data || "";
          tr.appendChild(tdData);

          const tdDesc = document.createElement("td");
          tdDesc.textContent = item.descricao || "";
          tr.appendChild(tdDesc);

          const tdPessoa = document.createElement("td");
          const pillPessoa = document.createElement("span");
          pillPessoa.textContent = item.pessoa || "";
          pillPessoa.className = "badge badge-pessoa";
          tdPessoa.appendChild(pillPessoa);
          tr.appendChild(tdPessoa);

          const tdTipo = document.createElement("td");
          const pillTipo = document.createElement("span");
          pillTipo.className = "badge " + (item.tipo === "receita" ? "badge-receita" : "badge-despesa");
          pillTipo.textContent = item.tipo === "receita" ? "Receita" : "Despesa";
          tdTipo.appendChild(pillTipo);
          tr.appendChild(tdTipo);

          const tdCat = document.createElement("td");
          tdCat.textContent = item.categoria || "";
          tr.appendChild(tdCat);

          const tdValor = document.createElement("td");
          const v = Number(item.valor) || 0;
          if (item.tipo === "receita") {
            tdValor.textContent = "+" + formatCurrency(v);
            tdValor.className = "amount-receita";
          } else {
            tdValor.textContent = "-" + formatCurrency(v);
            tdValor.className = "amount-despesa";
          }
          tr.appendChild(tdValor);

          const tdAcao = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "X";
          btn.className = "btn-danger";
          btn.addEventListener("click", () => {
            const allData = loadMovimentos();
            const idx = allData.findIndex(e => e.id === item.id);
            if (idx !== -1) {
              allData.splice(idx,1);
              saveMovimentos(allData);
              renderTudo();
            }
          });
          tdAcao.appendChild(btn);
          tr.appendChild(tdAcao);

          tbody.appendChild(tr);
        });
    }

    // Dashboard + gráficos
    let chart1, chart2, chart3;

    function renderDashboardEGraficos() {
      const all = loadMovimentos();
      const month = getCurrentMonth();
      const monthData = filterByMonth(all, month);
      const saldoInicialInput = document.getElementById("saldoInicial");
      const saldoInicial = Number(saldoInicialInput.value.replace(",", ".")) || 0;

      let totalDesp = 0;
      let totalRec = 0;

      // Totais por pessoa (só despesas)
      const porPessoa = { Helder:0, Namorada:0, Conjunto:0 };

      // Despesas por categoria
      const porCategoria = {};

      monthData.forEach(item => {
        const v = Number(item.valor) || 0;
        if (item.tipo === "despesa") {
          totalDesp += v;
          porPessoa[item.pessoa] = (porPessoa[item.pessoa] || 0) + v;
          porCategoria[item.categoria] = (porCategoria[item.categoria] || 0) + v;
        } else if (item.tipo === "receita") {
          totalRec += v;
        }
      });

      const poupanca = totalRec - totalDesp;
      const saldo = saldoInicial + poupanca;

      document.getElementById("totalDespesas").textContent = "-" + formatCurrency(totalDesp);
      document.getElementById("totalReceitas").textContent = formatCurrency(totalRec);
      document.getElementById("poupancaMes").textContent = formatCurrency(poupanca);
      document.getElementById("saldoMes").textContent = formatCurrency(saldo);

      // Metas/progresso
      const metas = loadMetas();
      const metaH = Number(metas.metaHelder || 0);
      const metaN = Number(metas.metaNamorada || 0);
      const metaC = Number(metas.metaConjunto || 0);
      const metaP = Number(metas.metaPoupanca || 0);

      const realH = porPessoa["Helder"] || 0;
      const realN = porPessoa["Namorada"] || 0;
      const realC = porPessoa["Conjunto"] || 0;
      const realP = poupanca;

      const setMetaRow = (metaValue, realValue, metaLabelId, realLabelId, barId, invertColors=false) => {
        const mLabel = document.getElementById(metaLabelId);
        const rLabel = document.getElementById(realLabelId);
        const bar = document.getElementById(barId);
        if (mLabel) mLabel.textContent = "Meta: " + (metaValue ? formatCurrency(metaValue) : "-");
        if (rLabel) rLabel.textContent = "Real: " + formatCurrency(realValue);
        if (bar) {
          let perc = metaValue ? (invertColors ? (realValue/metaValue)*100 : (realValue/metaValue)*100) : 0;
          if (!isFinite(perc)) perc = 0;
          if (perc > 100) perc = 100;
          bar.style.width = perc.toFixed(0) + "%";
        }
      };

      setMetaRow(metaH, realH, "metaHelderLabel", "realHelderLabel", "metaHelderBar");
      setMetaRow(metaN, realN, "metaNamoradaLabel", "realNamoradaLabel", "metaNamoradaBar");
      setMetaRow(metaC, realC, "metaConjuntoLabel", "realConjuntoLabel", "metaConjuntoBar");
      setMetaRow(metaP, realP, "metaPoupancaLabel", "realPoupancaLabel", "metaPoupancaBar", true);

      // Destruir gráficos antigos
      if (chart1) chart1.destroy();
      if (chart2) chart2.destroy();
      if (chart3) chart3.destroy();

      // Gráfico barras: despesas, receitas, saldo
      const ctx1 = document.getElementById("chartDespesas").getContext("2d");
      chart1 = new Chart(ctx1, {
        type: "bar",
        data: {
          labels: ["Despesas", "Receitas", "Saldo"],
          datasets: [{
            label: "€",
            data: [totalDesp, totalRec, saldo],
            backgroundColor: [
              "rgba(248,113,113,0.8)",
              "rgba(74,222,128,0.8)",
              "rgba(96,165,250,0.9)"
            ]
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.5)" }
            },
            x: {
              ticks: { color: "#9ca3af" },
              grid: { display: false }
            }
          }
        }
      });

      // Gráfico pie categorias
      const ctx2 = document.getElementById("chartCategorias").getContext("2d");
      chart2 = new Chart(ctx2, {
        type: "pie",
        data: {
          labels: Object.keys(porCategoria),
          datasets: [{
            data: Object.values(porCategoria),
            backgroundColor: [
              "#f97316","#fb7185","#22c55e","#0ea5e9","#a855f7","#eab308","#38bdf8"
            ]
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "#e5e7eb", font: { size: 10 } } } }
        }
      });

      // Gráfico doughnut por pessoa
      const ctx3 = document.getElementById("chartPorPessoa").getContext("2d");
      chart3 = new Chart(ctx3, {
        type: "doughnut",
        data: {
          labels: ["Helder","Namorada","Conjunto"],
          datasets: [{
            data: [porPessoa["Helder"]||0, porPessoa["Namorada"]||0, porPessoa["Conjunto"]||0],
            backgroundColor: ["#3b82f6","#f97316","#22c55e"]
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "#e5e7eb", font:{ size:10 } } } }
        }
      });
    }

    // Backup
    function exportBackup() {
      const payload = {
        movimentos: loadMovimentos(),
        categorias: loadCategorias(),
        debitos: loadDebitos(),
        metas: loadMetas(),
        saldoInicial: loadSaldoInicial()
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = new Date();
      const stamp = today.toISOString().slice(0,10);
      a.href = url;
      a.download = "despesas_backup_" + stamp + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importBackup(file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.movimentos) saveMovimentos(data.movimentos);
          if (data.categorias) saveCategorias(data.categorias);
          if (data.debitos) saveDebitos(data.debitos);
          if (data.metas) saveMetas(data.metas);
          if (typeof data.saldoInicial !== "undefined") saveSaldoInicial(data.saldoInicial);
          alert("Backup importado com sucesso!");
          renderTudo();
        } catch (e) {
          alert("Ficheiro de backup inválido.");
        }
      };
      reader.readAsText(file);
    }

    // Notificações de débitos diretos
    function requestNotificationPermission() {
      if (!("Notification" in window)) return;
      if (Notification.permission === "default") {
        try { Notification.requestPermission(); } catch {}
      }
    }

    function checkDebitosAndNotify() {
      const debitos = loadDebitos();
      if (!debitos.length) return;
      const notifArea = document.getElementById("notifArea");
      const notifList = document.getElementById("notifList");
      if (!notifArea || !notifList) return;

      const now = new Date();
      const todayDay = now.getDate();
      const todayISO = now.toISOString().slice(0,10);
      const notifState = loadNotifState();

      const todays = debitos.filter(d => Number(d.dia) === todayDay);
      notifList.innerHTML = "";

      if (todays.length) {
        todays.forEach(d => {
          // notificar apenas uma vez por dia
          if (notifState[d.id] === todayISO) return;
          const pill = document.createElement("span");
          pill.className = "notif-pill";
          pill.textContent = `${d.dia} · ${d.descricao} · ${formatCurrency(d.valor)} (${d.pessoa})`;
          notifList.appendChild(pill);

          // Notification API (só se permitido e página aberta)
          if ("Notification" in window && Notification.permission === "granted") {
            try {
              new Notification("Débito direto hoje", {
                body: `${d.descricao} · ${formatCurrency(d.valor)} · ${d.pessoa}`,
              });
            } catch {}
          }

          notifState[d.id] = todayISO;
        });

        if (notifList.children.length) {
          notifArea.style.display = "flex";
        } else {
          notifArea.style.display = "none";
        }
        saveNotifState(notifState);
      } else {
        notifArea.style.display = "none";
      }
    }

    function renderTudo() {
      // sincronizar mês default
      const monthInput = document.getElementById("monthFilter");
      if (monthInput && !monthInput.value) {
        monthInput.value = getCurrentMonth();
      }

      renderCategoriasUI();
      renderDebitosUI();
      renderTabelaMovimentos();
      renderDashboardEGraficos();
      renderMetasUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      // saldo inicial
      const saldoInicialInput = document.getElementById("saldoInicial");
      if (saldoInicialInput) {
        saldoInicialInput.value = loadSaldoInicial();
        saldoInicialInput.addEventListener("change", () => {
          const v = Number(saldoInicialInput.value.replace(",", ".")) || 0;
          saveSaldoInicial(v);
          renderDashboardEGraficos();
        });
      }

      const monthInput = document.getElementById("monthFilter");
      if (monthInput) {
        monthInput.value = getCurrentMonth();
        monthInput.addEventListener("change", () => {
          renderTabelaMovimentos();
          renderDashboardEGraficos();
        });
      }

      // Botão novo movimento
      const addBtn = document.getElementById("addBtn");
      if (addBtn) {
        addBtn.addEventListener("click", () => {
          const data = document.getElementById("data").value || new Date().toISOString().slice(0,10);
          const desc = document.getElementById("descricao").value.trim();
          const valor = Number((document.getElementById("valor").value || "").replace(",", "."));
          const tipo = document.getElementById("tipo").value;
          const pessoa = document.getElementById("pessoa").value;
          const categoria = document.getElementById("categoria").value;

          if (!desc || isNaN(valor)) {
            alert("Preenche pelo menos a descrição e o valor.");
            return;
          }
          const all = loadMovimentos();
          all.push({
            id: Date.now().toString(16) + Math.random().toString(16).slice(2),
            data,
            descricao: desc,
            valor,
            tipo,
            pessoa,
            categoria
          });
          saveMovimentos(all);

          document.getElementById("descricao").value = "";
          document.getElementById("valor").value = "";

          renderTabelaMovimentos();
          renderDashboardEGraficos();
        });
      }

      // Botão novas categorias
      const addCatBtn = document.getElementById("addCategoria");
      if (addCatBtn) {
        addCatBtn.addEventListener("click", () => {
          const input = document.getElementById("novaCategoria");
          const c = (input.value || "").trim();
          if (!c) return;
          const cats = loadCategorias();
          if (!cats.includes(c)) {
            cats.push(c);
            saveCategorias(cats);
          }
          input.value = "";
          renderCategoriasUI();
        });
      }

      // Botão adicionar débito direto
      const addDebitoBtn = document.getElementById("addDebitoBtn");
      if (addDebitoBtn) {
        addDebitoBtn.addEventListener("click", () => {
          const desc = document.getElementById("ddDescricao").value.trim();
          const valor = Number((document.getElementById("ddValor").value || "").replace(",", "."));
          const dia = Number(document.getElementById("ddDia").value);
          const pessoa = document.getElementById("ddPessoa").value;
          if (!desc || isNaN(valor) || !dia || dia < 1 || dia > 31) {
            alert("Preenche descrição, valor e um dia válido (1-31).");
            return;
          }
          const arr = loadDebitos();
          arr.push({
            id: Date.now().toString(16) + Math.random().toString(16).slice(2),
            descricao: desc,
            valor,
            dia,
            pessoa
          });
          saveDebitos(arr);
          document.getElementById("ddDescricao").value = "";
          document.getElementById("ddValor").value = "";
          document.getElementById("ddDia").value = "";
          renderDebitosUI();
          checkDebitosAndNotify();
        });
      }

      // Botão guardar metas
      const saveMetasBtn = document.getElementById("saveMetasBtn");
      if (saveMetasBtn) {
        saveMetasBtn.addEventListener("click", () => {
          const metas = {
            metaHelder: Number((document.getElementById("metaHelder").value || "").replace(",", ".")) || 0,
            metaNamorada: Number((document.getElementById("metaNamorada").value || "").replace(",", ".")) || 0,
            metaConjunto: Number((document.getElementById("metaConjunto").value || "").replace(",", ".")) || 0,
            metaPoupanca: Number((document.getElementById("metaPoupanca").value || "").replace(",", ".")) || 0,
            planeamentoNotas: document.getElementById("planeamentoNotas").value || ""
          };
          saveMetas(metas);
          renderDashboardEGraficos();
          alert("Metas guardadas!");
        });
      }

      // Backup
      const exportBtn = document.getElementById("exportBackupBtn");
      if (exportBtn) {
        exportBtn.addEventListener("click", exportBackup);
      }
      const backupInput = document.getElementById("backupFile");
      if (backupInput) {
        backupInput.addEventListener("change", (ev) => {
          if (ev.target.files && ev.target.files[0]) {
            importBackup(ev.target.files[0]);
            ev.target.value = "";
          }
        });
      }

      // Notificação barra fechar
      const notifClose = document.getElementById("notifClose");
      if (notifClose) {
        notifClose.addEventListener("click", () => {
          const notifArea = document.getElementById("notifArea");
          if (notifArea) notifArea.style.display = "none";
        });
      }

      // Render inicial
      renderTudo();

      // Notificações
      requestNotificationPermission();
      checkDebitosAndNotify();
      setInterval(checkDebitosAndNotify, 60 * 1000); // verifica a cada minuto
    });
  </script>
</body>
</html>
